' Gambas class file

Public persona As PersonaVO ''persona que proviene de la introduccion de clave
Public ManejadorPersona As New PersonaDAO
Private ManejadorPruebasTmpDato As New PruebasDAO 
Private PruebasTmpDato As PruebasVO

Private ruta_trabajo As String = User.Home & "/.leones" 'importante... ruta donde estan los ficheros de lectura...
Private ultimoobjeto As Label

Public Sub Form_Open()
  
  ModuleComun.copiarLecturas()
  
  Me.Center
  CargaInicialDatos()
  
End

Public Sub CargaInicialDatos()
  
  'carga ficheros 
  cargaficheros()
  
  'carga datos de todos los alumnos -> solo en el caso de que el profesor haya entrado
  Debug "Es un tipo de persona:", persona.tipo
  If persona.tipo = "Profesor" Then 
    TabStripVarias[1].Enabled = True
    TabStripVarias[1].Visible = True
    CargaAlumnos()
  Else
    TabStripVarias[1].Enabled = False
    TabStripVarias[1].Visible = False
  Endif
  'datos
  Me.Title = "Leones: " & persona.nombre
  
End

Public Sub cargaficheros()
  
  Dim res As Result 'result de las consultas de lecturas realizadas
  Dim VELOCIDAD As String
  
  Dim hboton As Button
  Dim arfile As String[]
  Dim hLabel As Label
  Dim hboxtemp As HBox
  Dim nombrefile As String
  Dim arraybto As New Variant[]
  
  Application.busy = 1
  arfile = Dir(ruta_trabajo, "*", gb.file)  'extraemos los ficheros
  
  ScrollViewDatosFicheros.Children.Clear() 'borrado de todo los controles que hubiensen
  
  hboxtemp = New HBox(ScrollViewDatosFicheros) 
  hboxtemp.h = 25
  hboxtemp.w = ScrollViewDatosFicheros.w - 10
  
  hlabel = New Label(hboxtemp) 
  hlabel.h = 15
  hlabel.expand = True
  hlabel.text = "ficheros"
  hlabel.Alignment = Align.Center
  hlabel.Border = Border.Plain
  hlabel.Background = Color.cyan
  
  hlabel = New Label(hboxtemp) 
  hlabel.h = 15
  hlabel.w = 150
  hlabel.Background = Color.cyan
  hlabel.Alignment = Align.Center
  hlabel.text = ("Puntuación")
  hlabel.Border = Border.Plain
  
  hlabel = New Label(hboxtemp) 
  hlabel.h = 15
  hlabel.w = 150
  hlabel.Background = Color.cyan
  hlabel.Alignment = Align.Center
  hlabel.text = ("Acción")
  hlabel.Border = Border.Plain
  
  For Each nombrefile In arfile.Sort(gb.Ascent)  'los mostramos ordenadamente...
    hboxtemp = New HBox(ScrollViewDatosFicheros) 
    hboxtemp.h = 25
    hboxtemp.w = ScrollViewDatosFicheros.w - 10
    
    hlabel = New Label(hboxtemp) As "GrupoFicheros"
    hlabel.h = 15
    hlabel.expand = True
    
    hlabel.text = nombrefile
    hlabel.Border = Border.Plain
    hlabel.Tooltip = ("haga doble click para seleccionar lectura")
    
    hlabel = New Label(hboxtemp)
    hlabel.h = 15
    hlabel.w = 150
    hlabel.Alignment = Align.Center
    hlabel.Border = Border.Plain
    hlabel.text = "0 p/m" 'dato por defecto...
    VELOCIDAD = hlabel.text 
    
    If persona.tipo = "Profesor" Then 
      'no pongo nada...porque es un profesor
      
    Else
      'tengo que cargar los datos de la lectura si los hubiera..
      'y si no pongo el dato por defecto
      
      ''TODO: ETAPA 2: res = ManejadorPruebasTmpDato.sql() 'buscar pruebas con maxima puntuacion, donde el alumno y la prueba lo tenemos
      res = ManejadorPruebasTmpDato.sql(Subst$("SELECT max(puntuacion) FROM pruebas where textolectura=\"&1\" and idpersona=&2",
        nombrefile, persona.idpersona))
      
      If Not IsNull(res) And If Not IsNull(res[0]) Then 
        ' '   'hay pruebas de ese alumno...
        hlabel.text = Str$(res[0]) & " p/m"
        
      Endif
      ' 
    Endif
    VELOCIDAD = hlabel.text
    
    hboton = New Button(hboxtemp) As "GrupoAccion"
    hboton.h = 15
    hboton.w = 150
    
    If VELOCIDAD = "0 p/m" Then 
      hboton.text = "Leer" 'si esta hecho seria, "Repetir"
    Else
      hboton.text = "Repetir" 'si esta hecho seria, "Repetir"
    Endif
    
    hboton.tag = "accion en fichero|" & ruta_trabajo & "/" & nombrefile
    
    'Si es profesor añadir un boton de editar lectura...
    If persona.tipo = "Profesor" Then 
      hboton.w = 75
      
      hboton = New Button(hboxtemp) As "GrupoAccionEditar"
      hboton.h = 15
      hboton.w = 75
      hboton.text = "Editar"
      hboton.tag = "editar en fichero|" & ruta_trabajo & "/" & nombrefile
      
    Endif
    
  Next  
  Application.busy = 0 
  
End

Public Sub GrupoAccionEditar_Click()
  
  'Message.Info("Editar fichero: " & Last.tag)
  
  FormEditorLecturas.Fichero_lectura = Last.tag
  
  FormEditorLecturas.ShowModal()
  
End

Public Sub GrupoFicheros_DblClick()
  
  If Not IsNull(ultimoobjeto) Then 
    ultimoobjeto.Background = Color.White
    
  Endif
  
  Last.Background = Color.Cyan
  
  ultimoobjeto = Last
  
End

Public Sub GrupoAccion_Click()
  'iniciar prueba...
  
  FormLectura.ficheroNombreLectura = Split(Last.tag, "|")[1]
  Try FormLectura.ficheroTexto = File.Load(FormLectura.ficheroNombreLectura)
  
  If Error Then 
    Message.Info(("Se ha producido un error al intentar leer el fichero de lectura"))
  Else
    FormLectura.PersonaVOtmp = persona
    FormLectura.showmodal()  
    
    cargaficheros() 'recarga informacion
  Endif
  
End

Public Sub ButtonConfigurar_Click()
  
  FormConfigurarTest.ShowDialog()
  
End

Public Sub ButtonEstadisticas_Click()
  
  FormEstadistica.PersonaVOtmp = persona
  FormEstadistica.ShowModal()
  
End

Public Sub CargaAlumnos()
  
  Dim resultado As Result
  Dim PersonaDAOTmp As New PersonaDao
  Dim nombre, nivel, clase As String
  Dim hboxtemp As Hbox
  Dim hlabel As Label
  Dim hboton As Button
  
  ScrollViewAlumnos.Children.Clear() 'borrado de todo los controles que hubiensen
  
  resultado = PersonaDAOtmp.sql("Select idpersona,nombre,nivel,clase,tipo from Persona")
  
  While resultado.Available
    
    If resultado["tipo"] = "Alumno" Then 
      hboxtemp = New Hbox(ScrollViewAlumnos)
      hboxtemp.h = 25
      hboxtemp.w = ScrollViewAlumnos.w - 10
      
      nombre = resultado["nombre"]
      '[
      hlabel = New Label(hboxtemp) As "GrupoAlumnos"
      hlabel.h = 15
      hlabel.expand = True
      hlabel.text = nombre
      hlabel.border = border.plain
      ']
      nivel = resultado["nivel"]
      '[
      hlabel = New Label(hboxtemp) As "GrupoAlumnos"
      hlabel.h = 15
      hlabel.expand = True
      hlabel.text = nivel
      hlabel.border = border.plain
      ']
      
      clase = resultado["clase"]
      '[
      hlabel = New Label(hboxtemp) As "GrupoAlumnos"
      hlabel.h = 15
      hlabel.expand = True
      hlabel.text = clase
      hlabel.border = border.plain
      ']
      'boton exportar dato del alumno..-> convertir datos a json, que luego pueda ser leido por el programa en otra ubicacion.
      '
      hboton = New Button(hboxtemp) As "grupoAlumnosImportarDatos" ''TODO: Crear datos en formato json para importar
      hboton.h = 15
      hboton.w = 30
      hboton.picture = Picture["icon:/16/copy"]
      hboton.tag = resultado["idpersona"]
      hboton.Tooltip = hboton.tag
      
      'boton para estadistica del alumno
      hboton = New Button(hboxtemp) As "grupoAlumnosEstadistica" ''TODO: Estadistica del Alumno
      hboton.h = 15
      hboton.w = 30
      hboton.picture = Picture["estadisticas16x16p.png"]
      hboton.tag = resultado["idpersona"]
      hboton.Tooltip = hboton.tag
      
      'boton para estadisticas del curso
      hboton = New Button(hboxtemp) As "grupoAlumnosEstadisticaClase" ''TODO: Crear estadistica de clase con las medias de alumnos
      hboton.h = 15
      hboton.w = 30
      hboton.picture = Picture["estadisticas16x16c.png"]
      hboton.tag = nivel & "|" & clase
      hboton.Tooltip = hboton.tag
    Endif
    resultado.movenext
  Wend
  
End

Public Sub ButtonCambiarAlumno_Click()
  
  Dim idactual As Integer
  ''TODO: abrir un formulario para cambio de alumno...
  idactual = persona.idpersona
  FormCambiarAlumno.personaActual = persona
  FormCambiarAlumno.Principal = Me
  FormCambiarAlumno.ShowModal()
  'cuando vuelve hay que actualizar datos...
  '¿se ha cambiado el usuario? Si... entonces recargar la información del usuario....
  
  If persona.idpersona = -999 Or persona.idpersona = idactual Then
    'se cancelo o cerro el formulario, restauro id y no hago nada mas
    persona.idpersona = idactual
    Return 
    
  Endif
  
  ''devuelta del formulario, si se ha recibido cambio de alumno, se actualizan los contenedores de datos del usuario actual
  ''
  CargaInicialDatos()
  
End

Public Sub ButtonAgregar_Click()
  
  Dialog.Title = "Elege nueva lectura"
  Dialog.Path = User.Home
  
  If Dialog.OpenFile() Then 
    Return 'el usuario cancelo la eleccion de fichero
  Endif
  
  'copiar el fichero al directorio de trabajo
  'fichero elegido ->   Dialog.Path
  'recargar las lecturas...
  '
  Copy Dialog.path To ruta_trabajo & "/" & File.Name(Dialog.path)
  
  Wait 0.5 'espera  para terminar de copiar...
  
  cargaficheros()
  
End
